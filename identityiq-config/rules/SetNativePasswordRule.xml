<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE Rule PUBLIC "sailpoint.dtd" "sailpoint.dtd">
<Rule name="SetNativePasswordRule" type="IdentityCreation">
  <Description>
    Sets the native SailPoint password to "Password123" only when a new Identity is created via the HR Employees authoritative source.
    Also assigns the "LCM" capability to the identity on creation.
  </Description>
  <Source>
    <![CDATA[
    import sailpoint.object.Identity;
    import sailpoint.object.Capability;
    import java.util.List;

    if (identity != null) {

        log.info("SetNativePasswordRule: Setting native password for new identity: " + identity.getName());

        // Set a hardcoded password
        identity.setPassword("Password123");

        // Check if identity already has LCM capability
        boolean hasLCM = false;
        List capabilities = identity.getCapabilities();
        for (Object cap : capabilities) {
            if (cap instanceof Capability && ((Capability) cap).getName().equals("LCM")) {
                hasLCM = true;
                break;
            }
        }

        if (!hasLCM) {
            Capability lcmCap = (Capability) context.getObjectByName(Capability.class, "LCM");
            if (lcmCap != null) {
                identity.addCapability(lcmCap);
                log.info("SetNativePasswordRule: LCM capability added to " + identity.getName());
            } else {
                log.warn("SetNativePasswordRule: LCM capability not found in the system.");
            }
        } else {
            log.info("SetNativePasswordRule: Identity already has LCM capability.");
        }
    }

    return identity;
    ]]>
  </Source>
</Rule>

